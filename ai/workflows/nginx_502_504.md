# Workflow: Nginx 502/504 (Upstream) — Full Triage

## Goal
Identify why Nginx is returning 502/504 and fix it permanently.

## Collect (agent should ask only if missing)
- Nginx error log lines around the failure
- Upstream app logs (gunicorn/flask) same timestamp
- Deployment topology: Nginx → upstream (unix socket or host:port)
- Timeouts: nginx proxy_read_timeout, gunicorn timeout

## Diagnose checklist (do in order)
1. **Is upstream alive?**
   - `curl -v http://127.0.0.1:<port>/healthz`
   - `ss -lntp | grep <port>` or socket existence
2. **Nginx → upstream connectivity**
   - wrong port, wrong socket path, permissions, SELinux/AppArmor
3. **Gunicorn/worker crashes**
   - OOM kills, import error, missing env vars, DB connection failures
4. **Timeout mismatch**
   - long request > nginx/gunicorn timeouts
5. **Body size / header size**
   - `client_max_body_size`, big cookies/headers
6. **Proxy buffering / streaming**
   - SSE/websocket needs special config
7. **DNS / upstream resolution**
   - if upstream is a hostname in Docker networks

## Permanent fixes (common)
- Align timeouts: nginx >= gunicorn >= app
- Add `/healthz` and use it for probes
- Add structured error logs (redacted)
- Ensure correct `proxy_set_header Host`, `X-Forwarded-*`
- For unix sockets: correct permissions, `user`/`group` alignment
- For docker: ensure same network and correct service name

## Output
- Root cause, evidence lines, fix patch (nginx + gunicorn/app)
- Verification: curl, logs, reload commands
- Rollback: revert config + restart
